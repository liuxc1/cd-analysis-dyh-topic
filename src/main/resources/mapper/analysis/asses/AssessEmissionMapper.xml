<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 在线监测数据 -->
<mapper namespace="ths.project.asses.mapper.AssessEmissionMapper">

	<select id="getRate" resultType="java.util.Map" parameterType="ths.project.asses.entity.AssessEmission">
		SELECT
			CASE WHEN SUMPM10 = 0 THEN 0 ELSE ROUND((PM10/SUMPM10)*100,1) END  RATEPM10,
			CASE WHEN SUMPM10 = 0 THEN 0 ELSE ROUND((PM25/SUMPM25)*100,1) END RATEPM25,
			CASE WHEN SUMPM10 = 0 THEN 0 ELSE ROUND((SO2/SUMSO2)*100,1) END RATESO2,
			CASE WHEN SUMPM10 = 0 THEN 0 ELSE ROUND((NOX/SUMNOX)*100,1) END RATENOX,
			CASE WHEN SUMPM10 = 0 THEN 0 ELSE ROUND((VOCS/SUMVOCS)*100,1) END RATEVOCS
		FROM (
				 SELECT
					 SUM(PM10) SUMPM10, SUM(PM25) SUMPM25,SUM(SO2) SUMSO2,SUM(NOX) SUMNOX,SUM(VOCS) SUMVOCS
				 FROM(
						 SELECT
							 CASE WHEN  B.PM10 =0  THEN 0 ELSE (A.PM10/B.PM10)*100 END  PM10,
							 CASE WHEN  B.PM25 =0 THEN 0 ELSE (A.PM25/B.PM25)*100 END PM25,
							 CASE WHEN  B.SO2 =0 THEN 0 ELSE (A.SO2/B.SO2)*100 END SO2,
							 CASE WHEN  B.NOX =0 THEN 0 ELSE (A.NOX/B.NOX)*100 END NOX,
							 CASE WHEN  B.VOCS =0 THEN 0 ELSE(A.VOCS/B.VOCS)*100 END VOCS
						 FROM (
								  SELECT  [SCENE_ID], [EMISSION_TYPE], [EMISSION_NAME], [EMISSION_BIG_TYPE], [EMISSION_COMPANY_TYPE], [EMISSION_COMPANY_NAME], [ALERT_LEVEL],
									  CAST ( ISNULL(PM10, 0 ) AS NUMERIC ( 10, 2 ) ) [PM10],
									  CAST ( ISNULL(PM25, 0 ) AS NUMERIC ( 10, 2 ) ) [PM25],
									  CAST ( ISNULL(SO2, 0 ) AS NUMERIC ( 10, 2 ) ) [SO2],
									  CAST ( ISNULL(NOX, 0 ) AS NUMERIC ( 10, 2 ) ) [NOX],
									  CAST ( ISNULL(VOCS, 0 ) AS NUMERIC ( 10, 2 ) ) [VOCS]
								  FROM [DBO].[T_ASSESS_EMISSION] WHERE SCENE_ID = #{sceneId} AND EMISSION_COMPANY_TYPE ='1' AND EMISSION_BIG_TYPE ='1' AND ALERT_LEVEL=#{alertLevel}
							  )A LEFT JOIN (
							 SELECT[SCENE_ID], [EMISSION_TYPE], [EMISSION_NAME], [EMISSION_BIG_TYPE], [EMISSION_COMPANY_TYPE], [EMISSION_COMPANY_NAME], [ALERT_LEVEL],
								 CAST ( ISNULL(PM10, 0 ) AS NUMERIC ( 10, 2 ) ) [PM10],
								 CAST ( ISNULL(PM25, 0 ) AS NUMERIC ( 10, 2 ) ) [PM25],
								 CAST ( ISNULL(SO2, 0 ) AS NUMERIC ( 10, 2 ) ) [SO2],
								 CAST ( ISNULL(NOX, 0 ) AS NUMERIC ( 10, 2 ) ) [NOX],
								 CAST ( ISNULL(VOCS, 0 ) AS NUMERIC ( 10, 2 ) ) [VOCS]
							 FROM [DBO].[T_ASSESS_EMISSION] WHERE SCENE_ID = #{sceneId} AND EMISSION_COMPANY_TYPE ='2' AND EMISSION_BIG_TYPE ='1' AND ALERT_LEVEL=#{alertLevel}
						 ) B ON A.EMISSION_TYPE=B.EMISSION_TYPE AND A.ALERT_LEVEL = B.ALERT_LEVEL
					 )AB
			 )T1 LEFT JOIN (
			SELECT
				SUM(CASE WHEN PM10 IS NULL OR PM10 ='' THEN 0 ELSE  CAST ( ISNULL( PM10, 0 ) AS NUMERIC ( 10, 2 ) )END)  PM10,
				SUM(CASE WHEN PM25 IS NULL OR PM25 ='' THEN 0 ELSE CAST ( ISNULL( PM25, 0 ) AS NUMERIC ( 10, 2 ) )END) PM25,
				SUM(CASE WHEN SO2 IS NULL OR SO2 ='' THEN 0 ELSE CAST ( ISNULL( SO2, 0 ) AS NUMERIC ( 10, 2 ) )END) SO2,
				SUM(CASE WHEN NOX IS NULL OR NOX ='' THEN 0 ELSE CAST ( ISNULL( NOX, 0 ) AS NUMERIC ( 10, 2 ) )END) NOX,
				SUM(CASE WHEN VOCS IS NULL OR VOCS ='' THEN 0 ELSE CAST ( ISNULL( VOCS, 0 ) AS NUMERIC ( 10, 2 ) )END) VOCS
			FROM [DBO].[T_ASSESS_EMISSION] WHERE SCENE_ID = #{sceneId}  AND EMISSION_BIG_TYPE ='1' AND EMISSION_COMPANY_TYPE ='1'AND ALERT_LEVEL=#{alertLevel}
		) T2 ON 1=1
	</select>
	
</mapper>

