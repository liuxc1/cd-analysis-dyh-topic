<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ths.air.web.analysis.sourceanalysis.SourceResolveMapper">
	<!--将数据导入时信息添加到T_COMM_FILE  -->
	<insert id="insertFile" parameterType="java.util.Map">
		INSERT INTO T_COMM_FILE (
		FILE_ID,
		ASCRIPTION_TYPE,
		ASCRIPTION_ID,
		FILE_FULL_NAME,
		FILE_NAME,
		FILE_ALIAS,
		FILE_TYPE,
		FILE_SIZE,
		FILE_FORMAT_SIZE,
		FILE_SAVE_PATH,
		TRANSFORM,
		TRANSFORM_TYPE,
		FILE_SOURCE,
		CREATE_USER,
		CREATE_TIME 
		)
		VALUES
			(
		#{FILE_ID},#{ASCRIPTION_TYPE},#{ASCRIPTION_ID},
		#{FILE_FULL_NAME},#{FILE_NAME},#{FILE_ALIAS},
		#{FILE_TYPE},#{FILE_SIZE},#{FILE_FORMAT_SIZE},
		#{FILE_SAVE_PATH},#{TRANSFORM},#{TRANSFORM_TYPE},#{FILE_SOURCE},
		#{CREATE_USER},#{CREATE_TIME})
	</insert>
	
	
	<update id="updatecitySequential" parameterType="java.util.Map">
		update T_ANS_SOURCE_SEQUENTIAL 
		set CITY_CODE=B.MANAGE_OBJ_CODE,CITY_NAME=B.MANAGE_OBJ_NAME
		from T_COMM_MANAGE_OBJ B
		where ASCRIPTION_ID = #{ASCRIPTION_ID} 
		and B.MANAGE_OBJ_TYPE='CITY'
	</update>	
	
	<update id="updatecityComprehensive" parameterType="java.util.Map">
		update T_ANS_SOURCE_COMPREHENSIVE 
		set CITY_CODE=B.MANAGE_OBJ_CODE,CITY_NAME=B.MANAGE_OBJ_NAME
		from T_COMM_MANAGE_OBJ B
		where ASCRIPTION_ID =#{ASCRIPTION_ID} 
		and B.MANAGE_OBJ_TYPE='CITY'
	</update>

	<update id="updateSourceTypeCode" parameterType="java.util.Map">
		update T_ANS_SOURCE_COMPREHENSIVE 
			set SOURCE_TYPE_CODE = B.DICTIONARY_CODE
		from JDP_EFORM_DICTIONARY B
		where ASCRIPTION_ID = #{ASCRIPTION_ID} 
		and B.DICTIONARY_TREE_ID='8fca1f95-0f9f-4bbb-b45a-3c613e1fffae'
		and SOURCE_TYPE_NAME = B.DICTIONARY_NAME
		
	</update>

	<update id="updateCityCalendarYear" parameterType="java.util.Map">
		update T_ANS_SOURCE_CALENDAR_YEAR 
		set CITY_CODE=B.MANAGE_OBJ_CODE,CITY_NAME=B.MANAGE_OBJ_NAME
		from T_COMM_MANAGE_OBJ B
		where ASCRIPTION_ID =#{ASCRIPTION_ID}
		and B.MANAGE_OBJ_TYPE='CITY'
	</update>

	<insert id="addReportInfos" parameterType="java.util.Map">
		INSERT INTO T_ANS_GENERAL_REPORT (
		REPORT_ID,
		ASCRIPTION_TYPE,
		REPORT_BATCH,
		REPORT_NAME,
		REPORT_TIME,
		REPORT_RATE,
		REPORT_FREQUENCY,
		REPORT_TYPE,
		REPORT_TIP,
		REMARK,
		FIELD1,
		FIELD2,
		FIELD3,
		FIELD4,
		FIELD5,
		FIELD6,
		REPORT_INSCRIBE,
		STATE,
		CREATE_TIME,
		CREATE_DEPT,
		CREATE_USER,
		EDIT_TIME,
		EDIT_USER 
		)
		VALUES
		(#{REPORT_ID},
		#{ASCRIPTION_TYPE},
		#{REPORT_BATCH},
		#{REPORT_NAME},
		#{REPORT_TIME},
		#{REPORT_RATE},
		#{REPORT_FREQUENCY},
		#{REPORT_TYPE},
		#{REPORT_TIP},
		#{REMARK},
		#{FIELD1},
		#{FIELD2},
		#{FIELD3},
		#{FIELD4},
		#{FIELD5},
		#{FIELD6},
		#{REPORT_INSCRIBE},
		#{STATE},
		#{CREATE_TIME},
		#{CREATE_DEPT},
		#{CREATE_USER},
		#{EDIT_TIME},
		#{EDIT_USER})
	</insert>
	
	<update id="updateReportInfos" parameterType="java.util.Map">
		UPDATE T_ANS_GENERAL_REPORT 
		SET FIELD1 = #{FIELD1},
		FIELD2 = #{FIELD2},
		FIELD3 = #{FIELD3},
		FIELD4 = #{FIELD4},
		FIELD5 = #{FIELD5},
		FIELD6 = #{FIELD6},
		EDIT_TIME=#{EDIT_TIME},
		EDIT_USER=#{EDIT_USER},
		REPORT_NAME = #{REPORT_NAME} 
		WHERE
		REPORT_ID = #{REPORT_ID}
	</update>
	
	
	<update id="updateReportInfosBySubmit" parameterType="java.util.Map">
		UPDATE T_ANS_GENERAL_REPORT 
		SET FIELD1 = #{FIELD1},
		FIELD2 = #{FIELD2},
		FIELD3 = #{FIELD3},
		FIELD4 = #{FIELD4},
		FIELD5 = #{FIELD5},
		FIELD6 = #{FIELD6},
		EDIT_TIME=#{EDIT_TIME},
		EDIT_USER=#{EDIT_USER},
		REPORT_NAME = #{REPORT_NAME},
		STATE = 'UPLOAD' WHERE
		REPORT_ID = #{REPORT_ID}
	</update>
	
	<delete id="deletefile" parameterType="java.util.Map">
		DELETE FROM T_COMM_FILE
		WHERE FILE_ID = #{FILE_ID}
		AND ASCRIPTION_TYPE = 'SOURCE_ANALYSIS'
	</delete>
	
	<delete id="deleteGeneralReportById" parameterType="java.util.Map">
		DELETE FROM T_ANS_GENERAL_REPORT
		WHERE REPORT_ID = #{FILE_ID}
		AND ASCRIPTION_TYPE = 'SOURCE_ANALYSIS'
	</delete>
	
	<delete id="deleteSourceSequentialById" parameterType="java.util.Map">
		DELETE FROM T_ANS_SOURCE_SEQUENTIAL
		WHERE ASCRIPTION_ID = #{FILE_ID}
		AND ASCRIPTION_TYPE = 'SOURCE_ANALYSIS'
	</delete>
	
	<delete id="deleteSourceComprehensiveById" parameterType="java.util.Map">
		DELETE FROM T_ANS_SOURCE_COMPREHENSIVE
		WHERE ASCRIPTION_ID = #{FILE_ID}
		AND ASCRIPTION_TYPE = 'SOURCE_ANALYSIS'
	</delete>
	<delete id="deleteCalendarYearById" parameterType="java.util.Map">
		DELETE FROM T_ANS_SOURCE_CALENDAR_YEAR
		WHERE ASCRIPTION_ID = #{FILE_ID}
		AND ASCRIPTION_TYPE = 'SOURCE_ANALYSIS'
	</delete>
	
	<!-- 根据填报年份查询报告文件信息 -->
	<select id="queryReportListByYear" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT
		A.REPORT_ID,
 		CONCAT( REPORT_NAME, CASE STATE WHEN 'UPLOAD' THEN '（'+EDIT_USER+'-已提交）' WHEN 'TEMP' THEN '（'+EDIT_USER+'）' END ) AS text,
 		A.REPORT_NAME,
 		CONVERT(VARCHAR ( 20 ), REPORT_TIME, 120 ) AS REPORT_TIME,
		A.CREATE_USER,
		A.FIELD1,
		A.FIELD2,
		A.FIELD3,
		A.FIELD4,
		A.FIELD5,
		A.FIELD6,
		A.STATE,
		B.FILE_TYPE,
		B.FILE_SAVE_PATH
	FROM
		T_ANS_GENERAL_REPORT A INNER JOIN T_COMM_FILE B ON A.REPORT_ID = B.FILE_ID
		AND A.ASCRIPTION_TYPE = 'SOURCE_ANALYSIS'
		AND A.REPORT_TIME = #{REPORT_TIME}
		ORDER BY A.CREATE_TIME ASC
	</select>
	
	<!--根据id来 查询报告文件信息 -->
	<select id="queryReportListById" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT CONVERT
		( VARCHAR ( 4 ), REPORT_TIME, 120 ) AS REPORT_TIME,
		REPORT_NAME,
		STATE,
		FIELD1,
		FIELD2,
		FIELD3,
		FIELD4,
		FIELD5,
		FIELD6
	FROM
		T_ANS_GENERAL_REPORT 
	WHERE
		ASCRIPTION_TYPE = 'SOURCE_ANALYSIS' 
		AND REPORT_ID = #{REPORT_ID}
	</select>
	
	
	
	<!-- 查询文件对应的浓度时序表 -->
	<select id="querySourceSequential" parameterType="java.util.Map" resultType="java.util.Map">
			SELECT  A.YEARS,A.POLLUTE,
       CASE WHEN B.WINTER = 0 THEN 0 ELSE ROUND(A.WINTER/B.WINTER*100,1) END WINTER_ZB,
			 CASE WHEN B.SPRING = 0 THEN 0 ELSE ROUND(A.SPRING/B.SPRING*100,1) END SPRING_ZB,
			 CASE WHEN B.SUMMER = 0 THEN 0 ELSE ROUND(A.SUMMER/B.SUMMER*100 ,1)END SUMMER_ZB,
       CASE WHEN B.AUTUMN = 0 THEN 0 ELSE ROUND(A.AUTUMN/B.AUTUMN*100,1) END AUTUMN_ZB,
			 CASE WHEN B.ANNUAL = 0 THEN 0 ELSE ROUND(A.ANNUAL/B.ANNUAL*100,1)END ANNUAL_ZB
		FROM (
			SELECT
					YEARS,POLLUTE_TYPE,POLLUTE,WINTER, SPRING,SUMMER,AUTUMN,ANNUAL FROM T_ANS_SOURCE_SEQUENTIAL 
				WHERE
					ASCRIPTION_ID = #{ASCRIPTION_ID} 
					AND ASCRIPTION_TYPE = 'SOURCE_ANALYSIS'
					AND POLLUTE_TYPE=#{POLLUTE_TYPE}
					 <if test="POLLUTE_TYPE=='PM25'">
					  	AND POLLUTE !='PM2.5'
					  </if>
				   <if test="POLLUTE_TYPE=='PM10'">
				  	AND POLLUTE != 'PM10'
				  </if>
					 GROUP BY YEARS,POLLUTE_TYPE,POLLUTE,WINTER, SPRING,SUMMER,AUTUMN,ANNUAL
			)A LEFT JOIN (
				SELECT
			YEARS,POLLUTE_TYPE,POLLUTE,WINTER, SPRING,SUMMER,AUTUMN,ANNUAL 
			FROM T_ANS_SOURCE_SEQUENTIAL 
			WHERE
				ASCRIPTION_ID = #{ASCRIPTION_ID} 
				AND ASCRIPTION_TYPE = 'SOURCE_ANALYSIS'
			  AND POLLUTE_TYPE= #{POLLUTE_TYPE}
			  <if test="POLLUTE_TYPE=='PM25'">
			  	AND POLLUTE = 'PM2.5'
			  </if>
			   <if test="POLLUTE_TYPE=='PM10'">
			  	AND POLLUTE = 'PM10'
			  </if>
			   GROUP BY YEARS,POLLUTE_TYPE,POLLUTE,WINTER, SPRING,SUMMER,AUTUMN,ANNUAL
				)B ON 1=1
	</select>
	
	<select id="querySourceComprehensive1" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT
		 '本地源' SOURCE_TYPE_NAME,SUM(PM25)PM25,SUM(PM10)PM10
		FROM
			T_ANS_SOURCE_COMPREHENSIVE 
		WHERE
			ASCRIPTION_ID = #{ASCRIPTION_ID}
			and ASCRIPTION_TYPE = 'SOURCE_ANALYSIS' 
			and SOURCE_TYPE_CODE !='QYYX'
			UNION ALL 
		SELECT
			SOURCE_TYPE_NAME,SUM(PM25)PM25,SUM(PM10)PM10
		FROM
			T_ANS_SOURCE_COMPREHENSIVE 
		WHERE
			ASCRIPTION_ID = #{ASCRIPTION_ID}
			and ASCRIPTION_TYPE = 'SOURCE_ANALYSIS' 
			and SOURCE_TYPE_CODE ='QYYX'
			GROUP BY SOURCE_TYPE_NAME
	</select>	
	
	<select id="querySourceComprehensive2" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT
		SOURCE_TYPE_CODE,SOURCE_TYPE_NAME,SUM(PM25)PM25,SUM(PM10)PM10
	FROM
		T_ANS_SOURCE_COMPREHENSIVE A 
	WHERE
		ASCRIPTION_ID = #{ASCRIPTION_ID}
		and ASCRIPTION_TYPE = 'SOURCE_ANALYSIS' 
		and SOURCE_TYPE_CODE !='QYYX'
		GROUP BY SOURCE_TYPE_CODE,SOURCE_TYPE_NAME
		ORDER BY SOURCE_TYPE_CODE
	</select>
	
	<select id="querySourceCalendarYear" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT CONVERT
		( VARCHAR ( 20 ), YEARS ) YEARS,
	CASE
		WHEN CONC = 0 THEN
		0 ELSE ROUND( MOBILE / CONC * 100, 1 ) 
		END MOBILE,
	CASE
		WHEN CONC = 0 THEN
		0 ELSE ROUND( INDUSTRIAL / CONC * 100, 1 ) 
		END INDUSTRIAL,
	CASE
		WHEN CONC = 0 THEN
		0 ELSE ROUND( DUST / CONC * 100, 1 ) 
		END DUST,
	CASE
		WHEN CONC = 0 THEN
		0 ELSE ROUND( RESIDENT_LIFE / CONC * 100, 1 ) 
		END RESIDENT_LIFE,
	CASE
		WHEN CONC = 0 THEN
		0 ELSE ROUND( OTHER / CONC * 100, 1 ) 
		END OTHER,
		CONC 
	FROM
		T_ANS_SOURCE_CALENDAR_YEAR 
	WHERE
		ASCRIPTION_ID = #{ASCRIPTION_ID}
		AND ASCRIPTION_TYPE = 'SOURCE_ANALYSIS' 
		AND POLLUTE = #{POLLUTE_TYPE} 
	ORDER BY
		YEARS
	</select>	
		
	

</mapper>

